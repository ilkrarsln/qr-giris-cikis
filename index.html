<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Panel</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>

<h2 id="title">Yükleniyor...</h2>

<div id="employerPanel" style="display:none">
  <h3>İş Yeri Ekle</h3>
  <input id="workplaceName" placeholder="İş yeri adı">
  <button onclick="addWorkplace()">Ekle</button>
  <hr>

<h3>Giriş / Çıkış</h3>

<button onclick="checkInOut('in')">Giriş Yap</button>
<button onclick="checkInOut('out')">Çıkış Yap</button>

<p id="result"></p>

</div>

<div id="employeePanel" style="display:none">
  <h3>Bağlı Olduğun İş Yerleri</h3>
  <ul id="workplaceList"></ul>
</div>

<script>
const SUPABASE_URL = "https://fqqmorvjwfxsqjwvdkgp.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZxcW1vcnZqd2Z4c3Fqd3Zka2dwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMDE0OTYsImV4cCI6MjA4Mzc3NzQ5Nn0.NVwFiL2mAGGroLlhbp10govDQhZBZzthClboBnsHpLw";

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_KEY
);

let currentUser = null;

async function loadUser() {
  const { data } = await supabaseClient.auth.getUser();
  if (!data.user) {
    alert("Giriş yapmalısın");
    return;
  }

  currentUser = data.user;

  const { data: profile } = await supabaseClient
    .from("profiles")
    .select("role")
    .eq("id", currentUser.id)
    .single();

  if (profile.role === "employer") {
    document.getElementById("title").innerText = "İşveren Paneli";
    document.getElementById("employerPanel").style.display = "block";
  } else {
    document.getElementById("title").innerText = "Çalışan Paneli";
    document.getElementById("employeePanel").style.display = "block";
    loadEmployeeWorkplaces();
  }
}

async function addWorkplace() {
  const name = document.getElementById("workplaceName").value;

  const { data, error } = await supabaseClient
    .from("workplaces")
    .insert({
      name: name,
      owner_id: currentUser.id
    })
    .select()
    .single();

  if (error) {
    alert(error.message);
    return;
  }

  await supabaseClient.from("workplace_users").insert({
    workplace_id: data.id,
    user_id: currentUser.id,
    role: "employer"
  });

  alert("İş yeri eklendi ✅");
}

async function loadEmployeeWorkplaces() {
  const { data } = await supabaseClient
    .from("workplace_users")
    .select("workplaces(name)")
    .eq("user_id", currentUser.id);

  const list = document.getElementById("workplaceList");
  list.innerHTML = "";

  data.forEach(w => {
    const li = document.createElement("li");
    li.innerText = w.workplaces.name;
    list.appendChild(li);
  });
}

loadUser();

  async function checkInOut(type) {
  document.getElementById("result").innerText = "Konum alınıyor...";

  navigator.geolocation.getCurrentPosition(
    async (position) => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;

      // ŞİMDİLİK: kullanıcının ilk iş yerini alıyoruz
      const { data: w } = await supabaseClient
        .from("workplace_users")
        .select("workplace_id")
        .eq("user_id", currentUser.id)
        .limit(1)
        .single();

      if (!w) {
        document.getElementById("result").innerText = "İş yeri bulunamadı";
        return;
      }

      await supabaseClient.from("attendance").insert({
        user_id: currentUser.id,
        workplace_id: w.workplace_id,
        type: type,
        lat: lat,
        lng: lng
      });

      document.getElementById("result").innerText =
        type === "in"
          ? "Giriş kaydedildi ✅"
          : "Çıkış kaydedildi ✅";
    },
    () => {
      document.getElementById("result").innerText =
        "Konum izni verilmedi ❌";
    }
  );
}

</script>

</body>
</html>
